import { web3Process } from './getWeb3'

const ethUtil = require('ethereumjs-util');
const sigUtil = require('eth-sig-util');

const LOCAL_STORAGE_KEY_TOKENS = 'tokens';
const terms = Buffer("IyBUZXJtcyBvZiBVc2UgIwoKKipUSElTIEFHUkVFTUVOVCBJUyBTVUJKRUNUIFRPIEJJTkRJTkcgQVJCSVRSQVRJT04gQU5EIEEgV0FJVkVSIE9GIENMQVNTIEFDVElPTiBSSUdIVFMgQVMgREVUQUlMRUQgSU4gU0VDVElPTiAxMy4gUExFQVNFIFJFQUQgVEhFIEFHUkVFTUVOVCBDQVJFRlVMTFkuKioKCl9PdXIgVGVybXMgb2YgVXNlIGhhdmUgYmVlbiB1cGRhdGVkIGFzIG9mIFNlcHRlbWJlciA1LCAyMDE2XwoKIyMgMS4gQWNjZXB0YW5jZSBvZiBUZXJtcyAjIwoKTWV0YU1hc2sgcHJvdmlkZXMgYSBwbGF0Zm9ybSBmb3IgbWFuYWdpbmcgRXRoZXJldW0gKG9yICJFVEgiKSBhY2NvdW50cywgYW5kIGFsbG93aW5nIG9yZGluYXJ5IHdlYnNpdGVzIHRvIGludGVyYWN0IHdpdGggdGhlIEV0aGVyZXVtIGJsb2NrY2hhaW4sIHdoaWxlIGtlZXBpbmcgdGhlIHVzZXIgaW4gY29udHJvbCBvdmVyIHdoYXQgdHJhbnNhY3Rpb25zIHRoZXkgYXBwcm92ZSwgdGhyb3VnaCBvdXIgd2Vic2l0ZSBsb2NhdGVkIGF0WyBdKGh0dHA6Ly9tZXRhbWFzay5pbylbaHR0cHM6Ly9tZXRhbWFzay5pby9dKGh0dHBzOi8vbWV0YW1hc2suaW8vKSBhbmQgYnJvd3NlciBwbHVnaW4gKHRoZSAiU2l0ZSIpIOKAlCB3aGljaCBpbmNsdWRlcyB0ZXh0LCBpbWFnZXMsIGF1ZGlvLCBjb2RlIGFuZCBvdGhlciBtYXRlcmlhbHMgIChjb2xsZWN0aXZlbHksIHRoZSDigJxDb250ZW504oCdKSBhbmQgYWxsIG9mIHRoZSBmZWF0dXJlcywgYW5kIHNlcnZpY2VzIHByb3ZpZGVkLiBUaGUgU2l0ZSwgYW5kIGFueSBvdGhlciBmZWF0dXJlcywgdG9vbHMsIG1hdGVyaWFscywgb3Igb3RoZXIgc2VydmljZXMgb2ZmZXJlZCBmcm9tIHRpbWUgdG8gdGltZSBieSBNZXRhTWFzayBhcmUgcmVmZXJyZWQgdG8gaGVyZSBhcyB0aGUg4oCcU2VydmljZS7igJ0gUGxlYXNlIHJlYWQgdGhlc2UgVGVybXMgb2YgVXNlICh0aGUg4oCcVGVybXPigJ0gb3Ig4oCcVGVybXMgb2YgVXNl4oCdKSBjYXJlZnVsbHkgYmVmb3JlIHVzaW5nIHRoZSBTZXJ2aWNlLiBCeSB1c2luZyBvciBvdGhlcndpc2UgYWNjZXNzaW5nIHRoZSBTZXJ2aWNlcywgb3IgY2xpY2tpbmcgdG8gYWNjZXB0IG9yIGFncmVlIHRvIHRoZXNlIFRlcm1zIHdoZXJlIHRoYXQgb3B0aW9uIGlzIG1hZGUgYXZhaWxhYmxlLCB5b3UgKDEpIGFjY2VwdCBhbmQgYWdyZWUgdG8gdGhlc2UgVGVybXMgKDIpIGNvbnNlbnQgdG8gdGhlIGNvbGxlY3Rpb24sIHVzZSwgZGlzY2xvc3VyZSBhbmQgb3RoZXIgaGFuZGxpbmcgb2YgaW5mb3JtYXRpb24gYXMgZGVzY3JpYmVkIGluIG91ciBQcml2YWN5IFBvbGljeSAgYW5kICgzKSBhbnkgYWRkaXRpb25hbCB0ZXJtcywgcnVsZXMgYW5kIGNvbmRpdGlvbnMgb2YgcGFydGljaXBhdGlvbiBpc3N1ZWQgYnkgTWV0YU1hc2sgZnJvbSB0aW1lIHRvIHRpbWUuIElmIHlvdSBkbyBub3QgYWdyZWUgdG8gdGhlIFRlcm1zLCB0aGVuIHlvdSBtYXkgbm90IGFjY2VzcyBvciB1c2UgdGhlIENvbnRlbnQgb3IgU2VydmljZXMuCgojIyAyLiBNb2RpZmljYXRpb24gb2YgVGVybXMgb2YgVXNlICMjCgpFeGNlcHQgZm9yIFNlY3Rpb24gMTMsIHByb3ZpZGluZyBmb3IgYmluZGluZyBhcmJpdHJhdGlvbiBhbmQgd2FpdmVyIG9mIGNsYXNzIGFjdGlvbiByaWdodHMsIE1ldGFNYXNrIHJlc2VydmVzIHRoZSByaWdodCwgYXQgaXRzIHNvbGUgZGlzY3JldGlvbiwgdG8gbW9kaWZ5IG9yIHJlcGxhY2UgdGhlIFRlcm1zIG9mIFVzZSBhdCBhbnkgdGltZS4gVGhlIG1vc3QgY3VycmVudCB2ZXJzaW9uIG9mIHRoZXNlIFRlcm1zIHdpbGwgYmUgcG9zdGVkIG9uIG91ciBTaXRlLiBZb3Ugc2hhbGwgYmUgcmVzcG9uc2libGUgZm9yIHJldmlld2luZyBhbmQgYmVjb21pbmcgZmFtaWxpYXIgd2l0aCBhbnkgc3VjaCBtb2RpZmljYXRpb25zLiBVc2Ugb2YgdGhlIFNlcnZpY2VzIGJ5IHlvdSBhZnRlciBhbnkgbW9kaWZpY2F0aW9uIHRvIHRoZSBUZXJtcyBjb25zdGl0dXRlcyB5b3VyIGFjY2VwdGFuY2Ugb2YgdGhlIFRlcm1zIG9mIFVzZSBhcyBtb2RpZmllZC4KCgoKIyMgMy4gRWxpZ2liaWxpdHkgIyMKCllvdSBoZXJlYnkgcmVwcmVzZW50IGFuZCB3YXJyYW50IHRoYXQgeW91IGFyZSBmdWxseSBhYmxlIGFuZCBjb21wZXRlbnQgdG8gZW50ZXIgaW50byB0aGUgdGVybXMsIGNvbmRpdGlvbnMsIG9ibGlnYXRpb25zLCBhZmZpcm1hdGlvbnMsIHJlcHJlc2VudGF0aW9ucyBhbmQgd2FycmFudGllcyBzZXQgZm9ydGggaW4gdGhlc2UgVGVybXMgYW5kIHRvIGFiaWRlIGJ5IGFuZCBjb21wbHkgd2l0aCB0aGVzZSBUZXJtcy4KCk1ldGFNYXNrIGlzIGEgZ2xvYmFsIHBsYXRmb3JtIGFuZCBieSBhY2Nlc3NpbmcgdGhlIENvbnRlbnQgb3IgU2VydmljZXMsIHlvdSBhcmUgcmVwcmVzZW50aW5nIGFuZCB3YXJyYW50aW5nIHRoYXQsIHlvdSBhcmUgb2YgdGhlIGxlZ2FsIGFnZSBvZiBtYWpvcml0eSBpbiB5b3VyIGp1cmlzZGljdGlvbiBhcyBpcyByZXF1aXJlZCB0byBhY2Nlc3Mgc3VjaCBTZXJ2aWNlcyBhbmQgQ29udGVudCBhbmQgZW50ZXIgaW50byBhcnJhbmdlbWVudHMgYXMgcHJvdmlkZWQgYnkgdGhlIFNlcnZpY2UuIFlvdSBmdXJ0aGVyIHJlcHJlc2VudCB0aGF0IHlvdSBhcmUgb3RoZXJ3aXNlIGxlZ2FsbHkgcGVybWl0dGVkIHRvIHVzZSB0aGUgc2VydmljZSBpbiB5b3VyIGp1cmlzZGljdGlvbiBpbmNsdWRpbmcgb3duaW5nIGNyeXB0b2dyYXBoaWMgdG9rZW5zIG9mIHZhbHVlLCBhbmQgaW50ZXJhY3Rpbmcgd2l0aCB0aGUgU2VydmljZXMgb3IgQ29udGVudCBpbiBhbnkgd2F5LiBZb3UgZnVydGhlciByZXByZXNlbnQgeW91IGFyZSByZXNwb25zaWJsZSBmb3IgZW5zdXJpbmcgY29tcGxpYW5jZSB3aXRoIHRoZSBsYXdzIG9mIHlvdXIganVyaXNkaWN0aW9uIGFuZCBhY2tub3dsZWRnZSB0aGF0IE1ldGFNYXNrIGlzIG5vdCBsaWFibGUgZm9yIHlvdXIgY29tcGxpYW5jZSB3aXRoIHN1Y2ggbGF3cy4KCiMjIDQgQWNjb3VudCBQYXNzd29yZCBhbmQgU2VjdXJpdHkgIyMKCldoZW4gc2V0dGluZyB1cCBhbiBhY2NvdW50IHdpdGhpbiBNZXRhTWFzaywgeW91IHdpbGwgYmUgcmVzcG9uc2libGUgZm9yIGtlZXBpbmcgeW91ciBvd24gYWNjb3VudCBzZWNyZXRzLCB3aGljaCBtYXkgYmUgYSB0d2VsdmUtd29yZCBzZWVkIHBocmFzZSwgYW4gYWNjb3VudCBmaWxlLCBvciBvdGhlciBsb2NhbGx5IHN0b3JlZCBzZWNyZXQgaW5mb3JtYXRpb24uIE1ldGFNYXNrIGVuY3J5cHRzIHRoaXMgaW5mb3JtYXRpb24gbG9jYWxseSB3aXRoIGEgcGFzc3dvcmQgeW91IHByb3ZpZGUsIHRoYXQgd2UgbmV2ZXIgc2VuZCB0byBvdXIgc2VydmVycy4gWW91IGFncmVlIHRvIChhKSBuZXZlciB1c2UgdGhlIHNhbWUgcGFzc3dvcmQgZm9yIE1ldGFNYXNrIHRoYXQgeW91IGhhdmUgZXZlciB1c2VkIG91dHNpZGUgb2YgdGhpcyBzZXJ2aWNlOyAoYikga2VlcCB5b3VyIHNlY3JldCBpbmZvcm1hdGlvbiBhbmQgcGFzc3dvcmQgY29uZmlkZW50aWFsIGFuZCBkbyBub3Qgc2hhcmUgdGhlbSB3aXRoIGFueW9uZSBlbHNlOyAoYykgaW1tZWRpYXRlbHkgbm90aWZ5IE1ldGFNYXNrIG9mIGFueSB1bmF1dGhvcml6ZWQgdXNlIG9mIHlvdXIgYWNjb3VudCBvciBicmVhY2ggb2Ygc2VjdXJpdHkuIE1ldGFNYXNrIGNhbm5vdCBhbmQgd2lsbCBub3QgYmUgbGlhYmxlIGZvciBhbnkgbG9zcyBvciBkYW1hZ2UgYXJpc2luZyBmcm9tIHlvdXIgZmFpbHVyZSB0byBjb21wbHkgd2l0aCB0aGlzIHNlY3Rpb24uCgojIyA1LiBSZXByZXNlbnRhdGlvbnMsIFdhcnJhbnRpZXMsIGFuZCBSaXNrcyAjIwoKIyMjIDUuMS4gV2FycmFudHkgRGlzY2xhaW1lciAjIyMKCllvdSBleHByZXNzbHkgdW5kZXJzdGFuZCBhbmQgYWdyZWUgdGhhdCB5b3VyIHVzZSBvZiB0aGUgU2VydmljZSBpcyBhdCB5b3VyIHNvbGUgcmlzay4gVGhlIFNlcnZpY2UgKGluY2x1ZGluZyB0aGUgU2VydmljZSBhbmQgdGhlIENvbnRlbnQpIGFyZSBwcm92aWRlZCBvbiBhbiAiQVMgSVMiIGFuZCAiYXMgYXZhaWxhYmxlIiBiYXNpcywgd2l0aG91dCB3YXJyYW50aWVzIG9mIGFueSBraW5kLCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLCBpbmNsdWRpbmcsIHdpdGhvdXQgbGltaXRhdGlvbiwgaW1wbGllZCB3YXJyYW50aWVzIG9mIG1lcmNoYW50YWJpbGl0eSwgZml0bmVzcyBmb3IgYSBwYXJ0aWN1bGFyIHB1cnBvc2Ugb3Igbm9uLWluZnJpbmdlbWVudC4gWW91IGFja25vd2xlZGdlIHRoYXQgTWV0YU1hc2sgaGFzIG5vIGNvbnRyb2wgb3ZlciwgYW5kIG5vIGR1dHkgdG8gdGFrZSBhbnkgYWN0aW9uIHJlZ2FyZGluZzogd2hpY2ggdXNlcnMgZ2FpbiBhY2Nlc3MgdG8gb3IgdXNlIHRoZSBTZXJ2aWNlOyB3aGF0IGVmZmVjdHMgdGhlIENvbnRlbnQgbWF5IGhhdmUgb24geW91OyBob3cgeW91IG1heSBpbnRlcnByZXQgb3IgdXNlIHRoZSBDb250ZW50OyBvciB3aGF0IGFjdGlvbnMgeW91IG1heSB0YWtlIGFzIGEgcmVzdWx0IG9mIGhhdmluZyBiZWVuIGV4cG9zZWQgdG8gdGhlIENvbnRlbnQuIFlvdSByZWxlYXNlIE1ldGFNYXNrIGZyb20gYWxsIGxpYWJpbGl0eSBmb3IgeW91IGhhdmluZyBhY3F1aXJlZCBvciBub3QgYWNxdWlyZWQgQ29udGVudCB0aHJvdWdoIHRoZSBTZXJ2aWNlLiBNZXRhTWFzayBtYWtlcyBubyByZXByZXNlbnRhdGlvbnMgY29uY2VybmluZyBhbnkgQ29udGVudCBjb250YWluZWQgaW4gb3IgYWNjZXNzZWQgdGhyb3VnaCB0aGUgU2VydmljZSwgYW5kIE1ldGFNYXNrIHdpbGwgbm90IGJlIHJlc3BvbnNpYmxlIG9yIGxpYWJsZSBmb3IgdGhlIGFjY3VyYWN5LCBjb3B5cmlnaHQgY29tcGxpYW5jZSwgbGVnYWxpdHkgb3IgZGVjZW5jeSBvZiBtYXRlcmlhbCBjb250YWluZWQgaW4gb3IgYWNjZXNzZWQgdGhyb3VnaCB0aGUgU2VydmljZS4KCiMjIyA1LjIgU29waGlzdGljYXRpb24gYW5kIFJpc2sgb2YgQ3J5cHRvZ3JhcGhpYyBTeXN0ZW1zICMjIwoKQnkgdXRpbGl6aW5nIHRoZSBTZXJ2aWNlIG9yIGludGVyYWN0aW5nIHdpdGggdGhlIENvbnRlbnQgb3IgcGxhdGZvcm0gaW4gYW55IHdheSwgeW91IHJlcHJlc2VudCB0aGF0IHlvdSB1bmRlcnN0YW5kIHRoZSBpbmhlcmVudCByaXNrcyBhc3NvY2lhdGVkIHdpdGggY3J5cHRvZ3JhcGhpYyBzeXN0ZW1zOyBhbmQgd2FycmFudCB0aGF0IHlvdSBoYXZlIGFuIHVuZGVyc3RhbmRpbmcgb2YgdGhlIHVzYWdlIGFuZCBpbnRyaWNhY2llcyBvZiBuYXRpdmUgY3J5cHRvZ3JhcGhpYyB0b2tlbnMsIGxpa2UgRXRoZXIgKEVUSCkgYW5kIEJpdGNvaW4gKEJUQyksIHNtYXJ0IGNvbnRyYWN0IGJhc2VkIHRva2VucyBzdWNoIGFzIHRob3NlIHRoYXQgZm9sbG93IHRoZSBFdGhlcmV1bSBUb2tlbiBTdGFuZGFyZCAoaHR0cHM6Ly9naXRodWIuY29tL2V0aGVyZXVtL0VJUHMvaXNzdWVzLzIwKSwgYW5kIGJsb2NrY2hhaW4tYmFzZWQgc29mdHdhcmUgc3lzdGVtcy4KCiMjIyA1LjMgUmlzayBvZiBSZWd1bGF0b3J5IEFjdGlvbnMgaW4gT25lIG9yIE1vcmUgSnVyaXNkaWN0aW9ucyAjIyMKCk1ldGFNYXNrIGFuZCBFVEggY291bGQgYmUgaW1wYWN0ZWQgYnkgb25lIG9yIG1vcmUgcmVndWxhdG9yeSBpbnF1aXJpZXMgb3IgcmVndWxhdG9yeSBhY3Rpb24sIHdoaWNoIGNvdWxkIGltcGVkZSBvciBsaW1pdCB0aGUgYWJpbGl0eSBvZiBNZXRhTWFzayB0byBjb250aW51ZSB0byBkZXZlbG9wLCBvciB3aGljaCBjb3VsZCBpbXBlZGUgb3IgbGltaXQgeW91ciBhYmlsaXR5IHRvIGFjY2VzcyBvciB1c2UgdGhlIFNlcnZpY2Ugb3IgRXRoZXJldW0gYmxvY2tjaGFpbi4KCiMjIyA1LjQgUmlzayBvZiBXZWFrbmVzc2VzIG9yIEV4cGxvaXRzIGluIHRoZSBGaWVsZCBvZiBDcnlwdG9ncmFwaHkgIyMjCgpZb3UgYWNrbm93bGVkZ2UgYW5kIHVuZGVyc3RhbmQgdGhhdCBDcnlwdG9ncmFwaHkgaXMgYSBwcm9ncmVzc2luZyBmaWVsZC4gQWR2YW5jZXMgaW4gY29kZSBjcmFja2luZyBvciB0ZWNobmljYWwgYWR2YW5jZXMgc3VjaCBhcyB0aGUgZGV2ZWxvcG1lbnQgb2YgcXVhbnR1bSBjb21wdXRlcnMgbWF5IHByZXNlbnQgcmlza3MgdG8gY3J5cHRvY3VycmVuY2llcyBhbmQgU2VydmljZXMgb2YgQ29udGVudCwgd2hpY2ggY291bGQgcmVzdWx0IGluIHRoZSB0aGVmdCBvciBsb3NzIG9mIHlvdXIgY3J5cHRvZ3JhcGhpYyB0b2tlbnMgb3IgcHJvcGVydHkuIFRvIHRoZSBleHRlbnQgcG9zc2libGUsIE1ldGFNYXNrIGludGVuZHMgdG8gdXBkYXRlIHRoZSBwcm90b2NvbCB1bmRlcmx5aW5nIFNlcnZpY2VzIHRvIGFjY291bnQgZm9yIGFueSBhZHZhbmNlcyBpbiBjcnlwdG9ncmFwaHkgYW5kIHRvIGluY29ycG9yYXRlIGFkZGl0aW9uYWwgc2VjdXJpdHkgbWVhc3VyZXMsIGJ1dCBkb2VzIG5vdCBndWFyYW50ZWUgb3Igb3RoZXJ3aXNlIHJlcHJlc2VudCBmdWxsIHNlY3VyaXR5IG9mIHRoZSBzeXN0ZW0uIEJ5IHVzaW5nIHRoZSBTZXJ2aWNlIG9yIGFjY2Vzc2luZyBDb250ZW50LCB5b3UgYWNrbm93bGVkZ2UgdGhlc2UgaW5oZXJlbnQgcmlza3MuCgojIyMgNS41IFZvbGF0aWxpdHkgb2YgQ3J5cHRvIEN1cnJlbmNpZXMgIyMjCgpZb3UgdW5kZXJzdGFuZCB0aGF0IEV0aGVyZXVtIGFuZCBvdGhlciBibG9ja2NoYWluIHRlY2hub2xvZ2llcyBhbmQgYXNzb2NpYXRlZCBjdXJyZW5jaWVzIG9yIHRva2VucyBhcmUgaGlnaGx5IHZvbGF0aWxlIGR1ZSB0byBtYW55IGZhY3RvcnMgaW5jbHVkaW5nIGJ1dCBub3QgbGltaXRlZCB0byBhZG9wdGlvbiwgc3BlY3VsYXRpb24sIHRlY2hub2xvZ3kgYW5kIHNlY3VyaXR5IHJpc2tzLiBZb3UgYWxzbyBhY2tub3dsZWRnZSB0aGF0IHRoZSBjb3N0IG9mIHRyYW5zYWN0aW5nIG9uIHN1Y2ggdGVjaG5vbG9naWVzIGlzIHZhcmlhYmxlIGFuZCBtYXkgaW5jcmVhc2UgYXQgYW55IHRpbWUgY2F1c2luZyBpbXBhY3QgdG8gYW55IGFjdGl2aXRpZXMgdGFraW5nIHBsYWNlIG9uIHRoZSBFdGhlcmV1bSBibG9ja2NoYWluLiBZb3UgYWNrbm93bGVkZ2UgdGhlc2Ugcmlza3MgYW5kIHJlcHJlc2VudCB0aGF0IE1ldGFNYXNrIGNhbm5vdCBiZSBoZWxkIGxpYWJsZSBmb3Igc3VjaCBmbHVjdHVhdGlvbnMgb3IgaW5jcmVhc2VkIGNvc3RzLgoKIyMjIDUuNiBBcHBsaWNhdGlvbiBTZWN1cml0eSAjIyMKCllvdSBhY2tub3dsZWRnZSB0aGF0IEV0aGVyZXVtIGFwcGxpY2F0aW9ucyBhcmUgY29kZSBzdWJqZWN0IHRvIGZsYXdzIGFuZCBhY2tub3dsZWRnZSB0aGF0IHlvdSBhcmUgc29sZWx5IHJlc3BvbnNpYmxlIGZvciBldmFsdWF0aW5nIGFueSBjb2RlIHByb3ZpZGVkIGJ5IHRoZSBTZXJ2aWNlcyBvciBDb250ZW50IGFuZCB0aGUgdHJ1c3R3b3J0aGluZXNzIG9mIGFueSB0aGlyZC1wYXJ0eSB3ZWJzaXRlcywgcHJvZHVjdHMsIHNtYXJ0LWNvbnRyYWN0cywgb3IgQ29udGVudCB5b3UgYWNjZXNzIG9yIHVzZSB0aHJvdWdoIHRoZSBTZXJ2aWNlLiBZb3UgZnVydGhlciBleHByZXNzbHkgYWNrbm93bGVkZ2UgYW5kIHJlcHJlc2VudCB0aGF0IEV0aGVyZXVtIGFwcGxpY2F0aW9ucyBjYW4gYmUgd3JpdHRlbiBtYWxpY2lvdXNseSBvciBuZWdsaWdlbnRseSwgdGhhdCBNZXRhTWFzayBjYW5ub3QgYmUgaGVsZCBsaWFibGUgZm9yIHlvdXIgaW50ZXJhY3Rpb24gd2l0aCBzdWNoIGFwcGxpY2F0aW9ucyBhbmQgdGhhdCBzdWNoIGFwcGxpY2F0aW9ucyBtYXkgY2F1c2UgdGhlIGxvc3Mgb2YgcHJvcGVydHkgb3IgZXZlbiBpZGVudGl0eS4gVGhpcyB3YXJuaW5nIGFuZCBvdGhlcnMgbGF0ZXIgcHJvdmlkZWQgYnkgTWV0YU1hc2sgaW4gbm8gd2F5IGV2aWRlbmNlIG9yIHJlcHJlc2VudCBhbiBvbi1nb2luZyBkdXR5IHRvIGFsZXJ0IHlvdSB0byBhbGwgb2YgdGhlIHBvdGVudGlhbCByaXNrcyBvZiB1dGlsaXppbmcgdGhlIFNlcnZpY2Ugb3IgQ29udGVudC4KCiMjIDYuIEluZGVtbml0eSAjIwoKWW91IGFncmVlIHRvIHJlbGVhc2UgYW5kIHRvIGluZGVtbmlmeSwgZGVmZW5kIGFuZCBob2xkIGhhcm1sZXNzIE1ldGFNYXNrIGFuZCBpdHMgcGFyZW50cywgc3Vic2lkaWFyaWVzLCBhZmZpbGlhdGVzIGFuZCBhZ2VuY2llcywgYXMgd2VsbCBhcyB0aGUgb2ZmaWNlcnMsIGRpcmVjdG9ycywgZW1wbG95ZWVzLCBzaGFyZWhvbGRlcnMgYW5kIHJlcHJlc2VudGF0aXZlcyBvZiBhbnkgb2YgdGhlIGZvcmVnb2luZyBlbnRpdGllcywgZnJvbSBhbmQgYWdhaW5zdCBhbnkgYW5kIGFsbCBsb3NzZXMsIGxpYWJpbGl0aWVzLCBleHBlbnNlcywgZGFtYWdlcywgY29zdHMgKGluY2x1ZGluZyBhdHRvcm5leXPigJkgZmVlcyBhbmQgY291cnQgY29zdHMpIGNsYWltcyBvciBhY3Rpb25zIG9mIGFueSBraW5kIHdoYXRzb2V2ZXIgYXJpc2luZyBvciByZXN1bHRpbmcgZnJvbSB5b3VyIHVzZSBvZiB0aGUgU2VydmljZSwgeW91ciB2aW9sYXRpb24gb2YgdGhlc2UgVGVybXMgb2YgVXNlLCBhbmQgYW55IG9mIHlvdXIgYWN0cyBvciBvbWlzc2lvbnMgdGhhdCBpbXBsaWNhdGUgcHVibGljaXR5IHJpZ2h0cywgZGVmYW1hdGlvbiBvciBpbnZhc2lvbiBvZiBwcml2YWN5LiBNZXRhTWFzayByZXNlcnZlcyB0aGUgcmlnaHQsIGF0IGl0cyBvd24gZXhwZW5zZSwgdG8gYXNzdW1lIGV4Y2x1c2l2ZSBkZWZlbnNlIGFuZCBjb250cm9sIG9mIGFueSBtYXR0ZXIgb3RoZXJ3aXNlIHN1YmplY3QgdG8gaW5kZW1uaWZpY2F0aW9uIGJ5IHlvdSBhbmQsIGluIHN1Y2ggY2FzZSwgeW91IGFncmVlIHRvIGNvb3BlcmF0ZSB3aXRoIE1ldGFNYXNrIGluIHRoZSBkZWZlbnNlIG9mIHN1Y2ggbWF0dGVyLgoKIyMgNy4gTGltaXRhdGlvbiBvbiBsaWFiaWxpdHkgIyMKCllPVSBBQ0tOT1dMRURHRSBBTkQgQUdSRUUgVEhBVCBZT1UgQVNTVU1FIEZVTEwgUkVTUE9OU0lCSUxJVFkgRk9SIFlPVVIgVVNFIE9GIFRIRSBTSVRFIEFORCBTRVJWSUNFLiBZT1UgQUNLTk9XTEVER0UgQU5EIEFHUkVFIFRIQVQgQU5ZIElORk9STUFUSU9OIFlPVSBTRU5EIE9SIFJFQ0VJVkUgRFVSSU5HIFlPVVIgVVNFIE9GIFRIRSBTSVRFIEFORCBTRVJWSUNFIE1BWSBOT1QgQkUgU0VDVVJFIEFORCBNQVkgQkUgSU5URVJDRVBURUQgT1IgTEFURVIgQUNRVUlSRUQgQlkgVU5BVVRIT1JJWkVEIFBBUlRJRVMuIFlPVSBBQ0tOT1dMRURHRSBBTkQgQUdSRUUgVEhBVCBZT1VSIFVTRSBPRiBUSEUgU0lURSBBTkQgU0VSVklDRSBJUyBBVCBZT1VSIE9XTiBSSVNLLiBSRUNPR05JWklORyBTVUNILCBZT1UgVU5ERVJTVEFORCBBTkQgQUdSRUUgVEhBVCwgVE8gVEhFIEZVTExFU1QgRVhURU5UIFBFUk1JVFRFRCBCWSBBUFBMSUNBQkxFIExBVywgTkVJVEhFUiBNRVRBTUFTSyBOT1IgSVRTIFNVUFBMSUVSUyBPUiBMSUNFTlNPUlMgV0lMTCBCRSBMSUFCTEUgVE8gWU9VIEZPUiBBTlkgRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgQ09OU0VRVUVOVElBTCwgUFVOSVRJVkUsIEVYRU1QTEFSWSBPUiBPVEhFUiBEQU1BR0VTIE9GIEFOWSBLSU5ELCBJTkNMVURJTkcgV0lUSE9VVCBMSU1JVEFUSU9OIERBTUFHRVMgRk9SIExPU1MgT0YgUFJPRklUUywgR09PRFdJTEwsIFVTRSwgREFUQSBPUiBPVEhFUiBUQU5HSUJMRSBPUiBJTlRBTkdJQkxFIExPU1NFUyBPUiBBTlkgT1RIRVIgREFNQUdFUyBCQVNFRCBPTiBDT05UUkFDVCwgVE9SVCwgU1RSSUNUIExJQUJJTElUWSBPUiBBTlkgT1RIRVIgVEhFT1JZIChFVkVOIElGIE1FVEFNQVNLIEhBRCBCRUVOIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFUyksIFJFU1VMVElORyBGUk9NIFRIRSBTSVRFIE9SIFNFUlZJQ0U7IFRIRSBVU0UgT1IgVEhFIElOQUJJTElUWSBUTyBVU0UgVEhFIFNJVEUgT1IgU0VSVklDRTsgVU5BVVRIT1JJWkVEIEFDQ0VTUyBUTyBPUiBBTFRFUkFUSU9OIE9GIFlPVVIgVFJBTlNNSVNTSU9OUyBPUiBEQVRBOyBTVEFURU1FTlRTIE9SIENPTkRVQ1QgT0YgQU5ZIFRISVJEIFBBUlRZIE9OIFRIRSBTSVRFIE9SIFNFUlZJQ0U7IEFOWSBBQ1RJT05TIFdFIFRBS0UgT1IgRkFJTCBUTyBUQUtFIEFTIEEgUkVTVUxUIE9GIENPTU1VTklDQVRJT05TIFlPVSBTRU5EIFRPIFVTOyBIVU1BTiBFUlJPUlM7IFRFQ0hOSUNBTCBNQUxGVU5DVElPTlM7IEZBSUxVUkVTLCBJTkNMVURJTkcgUFVCTElDIFVUSUxJVFkgT1IgVEVMRVBIT05FIE9VVEFHRVM7IE9NSVNTSU9OUywgSU5URVJSVVBUSU9OUywgTEFURU5DWSwgREVMRVRJT05TIE9SIERFRkVDVFMgT0YgQU5ZIERFVklDRSBPUiBORVRXT1JLLCBQUk9WSURFUlMsIE9SIFNPRlRXQVJFIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhPU0UgVEhBVCBETyBOT1QgUEVSTUlUIFBBUlRJQ0lQQVRJT04gSU4gVEhFIFNFUlZJQ0UpOyBBTlkgSU5KVVJZIE9SIERBTUFHRSBUTyBDT01QVVRFUiBFUVVJUE1FTlQ7IElOQUJJTElUWSBUTyBGVUxMWSBBQ0NFU1MgVEhFIFNJVEUgT1IgU0VSVklDRSBPUiBBTlkgT1RIRVIgV0VCU0lURTsgVEhFRlQsIFRBTVBFUklORywgREVTVFJVQ1RJT04sIE9SIFVOQVVUSE9SSVpFRCBBQ0NFU1MgVE8sIElNQUdFUyBPUiBPVEhFUiBDT05URU5UIE9GIEFOWSBLSU5EOyBEQVRBIFRIQVQgSVMgUFJPQ0VTU0VEIExBVEUgT1IgSU5DT1JSRUNUTFkgT1IgSVMgSU5DT01QTEVURSBPUiBMT1NUOyBUWVBPR1JBUEhJQ0FMLCBQUklOVElORyBPUiBPVEhFUiBFUlJPUlMsIE9SIEFOWSBDT01CSU5BVElPTiBUSEVSRU9GOyBPUiBBTlkgT1RIRVIgTUFUVEVSIFJFTEFUSU5HIFRPIFRIRSBTSVRFIE9SIFNFUlZJQ0UuCgpTT01FIEpVUklTRElDVElPTlMgRE8gTk9UIEFMTE9XIFRIRSBFWENMVVNJT04gT0YgQ0VSVEFJTiBXQVJSQU5USUVTIE9SIFRIRSBMSU1JVEFUSU9OIE9SIEVYQ0xVU0lPTiBPRiBMSUFCSUxJVFkgRk9SIElOQ0lERU5UQUwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTLiBBQ0NPUkRJTkdMWSwgU09NRSBPRiBUSEUgQUJPVkUgTElNSVRBVElPTlMgTUFZIE5PVCBBUFBMWSBUTyBZT1UuCgojIyA4LiBPdXIgUHJvcHJpZXRhcnkgUmlnaHRzICMjCgpBbGwgdGl0bGUsIG93bmVyc2hpcCBhbmQgaW50ZWxsZWN0dWFsIHByb3BlcnR5IHJpZ2h0cyBpbiBhbmQgdG8gdGhlIFNlcnZpY2UgYXJlIG93bmVkIGJ5IE1ldGFNYXNrIG9yIGl0cyBsaWNlbnNvcnMuIFlvdSBhY2tub3dsZWRnZSBhbmQgYWdyZWUgdGhhdCB0aGUgU2VydmljZSBjb250YWlucyBwcm9wcmlldGFyeSBhbmQgY29uZmlkZW50aWFsIGluZm9ybWF0aW9uIHRoYXQgaXMgcHJvdGVjdGVkIGJ5IGFwcGxpY2FibGUgaW50ZWxsZWN0dWFsIHByb3BlcnR5IGFuZCBvdGhlciBsYXdzLiBFeGNlcHQgYXMgZXhwcmVzc2x5IGF1dGhvcml6ZWQgYnkgTWV0YU1hc2ssIHlvdSBhZ3JlZSBub3QgdG8gY29weSwgbW9kaWZ5LCByZW50LCBsZWFzZSwgbG9hbiwgc2VsbCwgZGlzdHJpYnV0ZSwgcGVyZm9ybSwgZGlzcGxheSBvciBjcmVhdGUgZGVyaXZhdGl2ZSB3b3JrcyBiYXNlZCBvbiB0aGUgU2VydmljZSwgaW4gd2hvbGUgb3IgaW4gcGFydC4gTWV0YU1hc2sgaXNzdWVzIGEgbGljZW5zZSBmb3IgTWV0YU1hc2ssIGZvdW5kIFtoZXJlXShodHRwczovL2dpdGh1Yi5jb20vTWV0YU1hc2svbWV0YW1hc2stcGx1Z2luL2Jsb2IvbWFzdGVyL0xJQ0VOU0UpLiBGb3IgaW5mb3JtYXRpb24gb24gb3RoZXIgbGljZW5zZXMgdXRpbGl6ZWQgaW4gdGhlIGRldmVsb3BtZW50IG9mIE1ldGFNYXNrLCBwbGVhc2Ugc2VlIG91ciBhdHRyaWJ1dGlvbiBwYWdlIGF0OiBbaHR0cHM6Ly9tZXRhbWFzay5pby9hdHRyaWJ1dGlvbnMuaHRtbF0oaHR0cHM6Ly9tZXRhbWFzay5pby9hdHRyaWJ1dGlvbnMuaHRtbCkKCiMjIDkuIExpbmtzICMjCgpUaGUgU2VydmljZSBwcm92aWRlcywgb3IgdGhpcmQgcGFydGllcyBtYXkgcHJvdmlkZSwgbGlua3MgdG8gb3RoZXIgV29ybGQgV2lkZSBXZWIgIG9yIGFjY2Vzc2libGUgc2l0ZXMsIGFwcGxpY2F0aW9ucyBvciByZXNvdXJjZXMuIEJlY2F1c2UgTWV0YU1hc2sgaGFzIG5vIGNvbnRyb2wgb3ZlciBzdWNoIHNpdGVzLCBhcHBsaWNhdGlvbnMgYW5kIHJlc291cmNlcywgeW91IGFja25vd2xlZGdlIGFuZCBhZ3JlZSB0aGF0IE1ldGFNYXNrIGlzIG5vdCByZXNwb25zaWJsZSBmb3IgdGhlIGF2YWlsYWJpbGl0eSBvZiBzdWNoIGV4dGVybmFsIHNpdGVzLCBhcHBsaWNhdGlvbnMgb3IgcmVzb3VyY2VzLCBhbmQgZG9lcyBub3QgZW5kb3JzZSBhbmQgaXMgbm90IHJlc3BvbnNpYmxlIG9yIGxpYWJsZSBmb3IgYW55IGNvbnRlbnQsIGFkdmVydGlzaW5nLCBwcm9kdWN0cyBvciBvdGhlciBtYXRlcmlhbHMgb24gb3IgYXZhaWxhYmxlIGZyb20gc3VjaCBzaXRlcyBvciByZXNvdXJjZXMuIFlvdSBmdXJ0aGVyIGFja25vd2xlZGdlIGFuZCBhZ3JlZSB0aGF0IE1ldGFNYXNrIHNoYWxsIG5vdCBiZSByZXNwb25zaWJsZSBvciBsaWFibGUsIGRpcmVjdGx5IG9yIGluZGlyZWN0bHksIGZvciBhbnkgZGFtYWdlIG9yIGxvc3MgY2F1c2VkIG9yIGFsbGVnZWQgdG8gYmUgY2F1c2VkIGJ5IG9yIGluIGNvbm5lY3Rpb24gd2l0aCB1c2Ugb2Ygb3IgcmVsaWFuY2Ugb24gYW55IHN1Y2ggY29udGVudCwgZ29vZHMgb3Igc2VydmljZXMgYXZhaWxhYmxlIG9uIG9yIHRocm91Z2ggYW55IHN1Y2ggc2l0ZSBvciByZXNvdXJjZS4KCiMjIDEwLiBUZXJtaW5hdGlvbiBhbmQgU3VzcGVuc2lvbiAjIwoKTWV0YU1hc2sgbWF5IHRlcm1pbmF0ZSBvciBzdXNwZW5kIGFsbCBvciBwYXJ0IG9mIHRoZSBTZXJ2aWNlIGFuZCB5b3VyIE1ldGFNYXNrIGFjY2VzcyBpbW1lZGlhdGVseSwgd2l0aG91dCBwcmlvciBub3RpY2Ugb3IgbGlhYmlsaXR5LCBpZiB5b3UgYnJlYWNoIGFueSBvZiB0aGUgdGVybXMgb3IgY29uZGl0aW9ucyBvZiB0aGUgVGVybXMuIFVwb24gdGVybWluYXRpb24gb2YgeW91ciBhY2Nlc3MsIHlvdXIgcmlnaHQgdG8gdXNlIHRoZSBTZXJ2aWNlIHdpbGwgaW1tZWRpYXRlbHkgY2Vhc2UuCgpUaGUgZm9sbG93aW5nIHByb3Zpc2lvbnMgb2YgdGhlIFRlcm1zIHN1cnZpdmUgYW55IHRlcm1pbmF0aW9uIG9mIHRoZXNlIFRlcm1zOiBJTkRFTU5JVFk7IFdBUlJBTlRZIERJU0NMQUlNRVJTOyBMSU1JVEFUSU9OIE9OIExJQUJJTElUWTsgT1VSIFBST1BSSUVUQVJZIFJJR0hUUzsgTElOS1M7IFRFUk1JTkFUSU9OOyBOTyBUSElSRCBQQVJUWSBCRU5FRklDSUFSSUVTOyBCSU5ESU5HIEFSQklUUkFUSU9OIEFORCBDTEFTUyBBQ1RJT04gV0FJVkVSOyBHRU5FUkFMIElORk9STUFUSU9OLgoKIyMgMTEuIE5vIFRoaXJkIFBhcnR5IEJlbmVmaWNpYXJpZXMgIyMKCllvdSBhZ3JlZSB0aGF0LCBleGNlcHQgYXMgb3RoZXJ3aXNlIGV4cHJlc3NseSBwcm92aWRlZCBpbiB0aGVzZSBUZXJtcywgdGhlcmUgc2hhbGwgYmUgbm8gdGhpcmQgcGFydHkgYmVuZWZpY2lhcmllcyB0byB0aGUgVGVybXMuCgojIyAxMi4gTm90aWNlIGFuZCBQcm9jZWR1cmUgRm9yIE1ha2luZyBDbGFpbXMgb2YgQ29weXJpZ2h0IEluZnJpbmdlbWVudCAjIwoKSWYgeW91IGJlbGlldmUgdGhhdCB5b3VyIGNvcHlyaWdodCBvciB0aGUgY29weXJpZ2h0IG9mIGEgcGVyc29uIG9uIHdob3NlIGJlaGFsZiB5b3UgYXJlIGF1dGhvcml6ZWQgdG8gYWN0IGhhcyBiZWVuIGluZnJpbmdlZCwgcGxlYXNlIHByb3ZpZGUgTWV0YU1hc2vigJlzIENvcHlyaWdodCBBZ2VudCBhIHdyaXR0ZW4gTm90aWNlIGNvbnRhaW5pbmcgdGhlIGZvbGxvd2luZyBpbmZvcm1hdGlvbjoKCsK3IGFuIGVsZWN0cm9uaWMgb3IgcGh5c2ljYWwgc2lnbmF0dXJlIG9mIHRoZSBwZXJzb24gYXV0aG9yaXplZCB0byBhY3Qgb24gYmVoYWxmIG9mIHRoZSBvd25lciBvZiB0aGUgY29weXJpZ2h0IG9yIG90aGVyIGludGVsbGVjdHVhbCBwcm9wZXJ0eSBpbnRlcmVzdDsKCsK3IGEgZGVzY3JpcHRpb24gb2YgdGhlIGNvcHlyaWdodGVkIHdvcmsgb3Igb3RoZXIgaW50ZWxsZWN0dWFsIHByb3BlcnR5IHRoYXQgeW91IGNsYWltIGhhcyBiZWVuIGluZnJpbmdlZDsKCsK3IGEgZGVzY3JpcHRpb24gb2Ygd2hlcmUgdGhlIG1hdGVyaWFsIHRoYXQgeW91IGNsYWltIGlzIGluZnJpbmdpbmcgaXMgbG9jYXRlZCBvbiB0aGUgU2VydmljZTsKCsK3IHlvdXIgYWRkcmVzcywgdGVsZXBob25lIG51bWJlciwgYW5kIGVtYWlsIGFkZHJlc3M7CgrCtyBhIHN0YXRlbWVudCBieSB5b3UgdGhhdCB5b3UgaGF2ZSBhIGdvb2QgZmFpdGggYmVsaWVmIHRoYXQgdGhlIGRpc3B1dGVkIHVzZSBpcyBub3QgYXV0aG9yaXplZCBieSB0aGUgY29weXJpZ2h0IG93bmVyLCBpdHMgYWdlbnQsIG9yIHRoZSBsYXc7CgrCtyBhIHN0YXRlbWVudCBieSB5b3UsIG1hZGUgdW5kZXIgcGVuYWx0eSBvZiBwZXJqdXJ5LCB0aGF0IHRoZSBhYm92ZSBpbmZvcm1hdGlvbiBpbiB5b3VyIE5vdGljZSBpcyBhY2N1cmF0ZSBhbmQgdGhhdCB5b3UgYXJlIHRoZSBjb3B5cmlnaHQgb3IgaW50ZWxsZWN0dWFsIHByb3BlcnR5IG93bmVyIG9yIGF1dGhvcml6ZWQgdG8gYWN0IG9uIHRoZSBjb3B5cmlnaHQgb3IgaW50ZWxsZWN0dWFsIHByb3BlcnR5IG93bmVyJ3MgYmVoYWxmLgoKTWV0YU1hc2vigJlzIENvcHlyaWdodCBBZ2VudCBjYW4gYmUgcmVhY2hlZCBhdDoKCkVtYWlsOiBjb3B5cmlnaHQgW2F0XSBtZXRhbWFzayBbZG90XSBpbwoKTWFpbDoKCkF0dGVudGlvbjoKCk1ldGFNYXNrIENvcHlyaWdodCDihIUgQ29uc2VuU3lzCgo0OSBCb2dhcnQgU3RyZWV0CgpCcm9va2x5biwgTlkgMTEyMDYKCiMjIDEzLiBCaW5kaW5nIEFyYml0cmF0aW9uIGFuZCBDbGFzcyBBY3Rpb24gV2FpdmVyICMjCgpQTEVBU0UgUkVBRCBUSElTIFNFQ1RJT04gQ0FSRUZVTExZIOKAkyBJVCBNQVkgU0lHTklGSUNBTlRMWSBBRkZFQ1QgWU9VUiBMRUdBTCBSSUdIVFMsIElOQ0xVRElORyBZT1VSIFJJR0hUIFRPIEZJTEUgQSBMQVdTVUlUIElOIENPVVJUCgojIyMgMTMuMSBJbml0aWFsIERpc3B1dGUgUmVzb2x1dGlvbiAjIyMKClRoZSBwYXJ0aWVzIHNoYWxsIHVzZSB0aGVpciBiZXN0IGVmZm9ydHMgdG8gZW5nYWdlIGRpcmVjdGx5IHRvIHNldHRsZSBhbnkgZGlzcHV0ZSwgY2xhaW0sIHF1ZXN0aW9uLCBvciBkaXNhZ3JlZW1lbnQgYW5kIGVuZ2FnZSBpbiBnb29kIGZhaXRoIG5lZ290aWF0aW9ucyB3aGljaCBzaGFsbCBiZSBhIGNvbmRpdGlvbiB0byBlaXRoZXIgcGFydHkgaW5pdGlhdGluZyBhIGxhd3N1aXQgb3IgYXJiaXRyYXRpb24uCgojIyMgMTMuMiBCaW5kaW5nIEFyYml0cmF0aW9uICMjIwoKSWYgdGhlIHBhcnRpZXMgZG8gbm90IHJlYWNoIGFuIGFncmVlZCB1cG9uIHNvbHV0aW9uIHdpdGhpbiBhIHBlcmlvZCBvZiAzMCBkYXlzIGZyb20gdGhlIHRpbWUgaW5mb3JtYWwgZGlzcHV0ZSByZXNvbHV0aW9uIHVuZGVyIHRoZSBJbml0aWFsIERpc3B1dGUgUmVzb2x1dGlvbiBwcm92aXNpb24gYmVnaW5zLCB0aGVuIGVpdGhlciBwYXJ0eSBtYXkgaW5pdGlhdGUgYmluZGluZyBhcmJpdHJhdGlvbiBhcyB0aGUgc29sZSBtZWFucyB0byByZXNvbHZlIGNsYWltcywgc3ViamVjdCB0byB0aGUgdGVybXMgc2V0IGZvcnRoIGJlbG93LiBTcGVjaWZpY2FsbHksIGFsbCBjbGFpbXMgYXJpc2luZyBvdXQgb2Ygb3IgcmVsYXRpbmcgdG8gdGhlc2UgVGVybXMgKGluY2x1ZGluZyB0aGVpciBmb3JtYXRpb24sIHBlcmZvcm1hbmNlIGFuZCBicmVhY2gpLCB0aGUgcGFydGllc+KAmSByZWxhdGlvbnNoaXAgd2l0aCBlYWNoIG90aGVyIGFuZC9vciB5b3VyIHVzZSBvZiB0aGUgU2VydmljZSBzaGFsbCBiZSBmaW5hbGx5IHNldHRsZWQgYnkgYmluZGluZyBhcmJpdHJhdGlvbiBhZG1pbmlzdGVyZWQgYnkgdGhlIEFtZXJpY2FuIEFyYml0cmF0aW9uIEFzc29jaWF0aW9uIGluIGFjY29yZGFuY2Ugd2l0aCB0aGUgcHJvdmlzaW9ucyBvZiBpdHMgQ29tbWVyY2lhbCBBcmJpdHJhdGlvbiBSdWxlcyBhbmQgdGhlIHN1cHBsZW1lbnRhcnkgcHJvY2VkdXJlcyBmb3IgY29uc3VtZXIgcmVsYXRlZCBkaXNwdXRlcyBvZiB0aGUgQW1lcmljYW4gQXJiaXRyYXRpb24gQXNzb2NpYXRpb24gKHRoZSAiQUFBIiksIGV4Y2x1ZGluZyBhbnkgcnVsZXMgb3IgcHJvY2VkdXJlcyBnb3Zlcm5pbmcgb3IgcGVybWl0dGluZyBjbGFzcyBhY3Rpb25zLgoKVGhlIGFyYml0cmF0b3IsIGFuZCBub3QgYW55IGZlZGVyYWwsIHN0YXRlIG9yIGxvY2FsIGNvdXJ0IG9yIGFnZW5jeSwgc2hhbGwgaGF2ZSBleGNsdXNpdmUgYXV0aG9yaXR5IHRvIHJlc29sdmUgYWxsIGRpc3B1dGVzIGFyaXNpbmcgb3V0IG9mIG9yIHJlbGF0aW5nIHRvIHRoZSBpbnRlcnByZXRhdGlvbiwgYXBwbGljYWJpbGl0eSwgZW5mb3JjZWFiaWxpdHkgb3IgZm9ybWF0aW9uIG9mIHRoZXNlIFRlcm1zLCBpbmNsdWRpbmcsIGJ1dCBub3QgbGltaXRlZCB0byBhbnkgY2xhaW0gdGhhdCBhbGwgb3IgYW55IHBhcnQgb2YgdGhlc2UgVGVybXMgYXJlIHZvaWQgb3Igdm9pZGFibGUsIG9yIHdoZXRoZXIgYSBjbGFpbSBpcyBzdWJqZWN0IHRvIGFyYml0cmF0aW9uLiBUaGUgYXJiaXRyYXRvciBzaGFsbCBiZSBlbXBvd2VyZWQgdG8gZ3JhbnQgd2hhdGV2ZXIgcmVsaWVmIHdvdWxkIGJlIGF2YWlsYWJsZSBpbiBhIGNvdXJ0IHVuZGVyIGxhdyBvciBpbiBlcXVpdHkuIFRoZSBhcmJpdHJhdG9y4oCZcyBhd2FyZCBzaGFsbCBiZSB3cml0dGVuLCBhbmQgYmluZGluZyBvbiB0aGUgcGFydGllcyBhbmQgbWF5IGJlIGVudGVyZWQgYXMgYSBqdWRnbWVudCBpbiBhbnkgY291cnQgb2YgY29tcGV0ZW50IGp1cmlzZGljdGlvbi4KClRoZSBwYXJ0aWVzIHVuZGVyc3RhbmQgdGhhdCwgYWJzZW50IHRoaXMgbWFuZGF0b3J5IHByb3Zpc2lvbiwgdGhleSB3b3VsZCBoYXZlIHRoZSByaWdodCB0byBzdWUgaW4gY291cnQgYW5kIGhhdmUgYSBqdXJ5IHRyaWFsLiBUaGV5IGZ1cnRoZXIgdW5kZXJzdGFuZCB0aGF0LCBpbiBzb21lIGluc3RhbmNlcywgdGhlIGNvc3RzIG9mIGFyYml0cmF0aW9uIGNvdWxkIGV4Y2VlZCB0aGUgY29zdHMgb2YgbGl0aWdhdGlvbiBhbmQgdGhlIHJpZ2h0IHRvIGRpc2NvdmVyeSBtYXkgYmUgbW9yZSBsaW1pdGVkIGluIGFyYml0cmF0aW9uIHRoYW4gaW4gY291cnQuCgojIyMgMTMuMyBMb2NhdGlvbiAjIyMKCkJpbmRpbmcgYXJiaXRyYXRpb24gc2hhbGwgdGFrZSBwbGFjZSBpbiBOZXcgWW9yay4gWW91IGFncmVlIHRvIHN1Ym1pdCB0byB0aGUgcGVyc29uYWwganVyaXNkaWN0aW9uIG9mIGFueSBmZWRlcmFsIG9yIHN0YXRlIGNvdXJ0IGluIE5ldyBZb3JrIENvdW50eSwgTmV3IFlvcmssIGluIG9yZGVyIHRvIGNvbXBlbCBhcmJpdHJhdGlvbiwgdG8gc3RheSBwcm9jZWVkaW5ncyBwZW5kaW5nIGFyYml0cmF0aW9uLCBvciB0byBjb25maXJtLCBtb2RpZnksIHZhY2F0ZSBvciBlbnRlciBqdWRnbWVudCBvbiB0aGUgYXdhcmQgZW50ZXJlZCBieSB0aGUgYXJiaXRyYXRvci4KCiMjIyAxMy40IENsYXNzIEFjdGlvbiBXYWl2ZXIgIyMjCgpUaGUgcGFydGllcyBmdXJ0aGVyIGFncmVlIHRoYXQgYW55IGFyYml0cmF0aW9uIHNoYWxsIGJlIGNvbmR1Y3RlZCBpbiB0aGVpciBpbmRpdmlkdWFsIGNhcGFjaXRpZXMgb25seSBhbmQgbm90IGFzIGEgY2xhc3MgYWN0aW9uIG9yIG90aGVyIHJlcHJlc2VudGF0aXZlIGFjdGlvbiwgYW5kIHRoZSBwYXJ0aWVzIGV4cHJlc3NseSB3YWl2ZSB0aGVpciByaWdodCB0byBmaWxlIGEgY2xhc3MgYWN0aW9uIG9yIHNlZWsgcmVsaWVmIG9uIGEgY2xhc3MgYmFzaXMuIFlPVSBBTkQgTUVUQU1BU0sgQUdSRUUgVEhBVCBFQUNIIE1BWSBCUklORyBDTEFJTVMgQUdBSU5TVCBUSEUgT1RIRVIgT05MWSBJTiBZT1VSIE9SIElUUyBJTkRJVklEVUFMIENBUEFDSVRZLCBBTkQgTk9UIEFTIEEgUExBSU5USUZGIE9SIENMQVNTIE1FTUJFUiBJTiBBTlkgUFVSUE9SVEVEIENMQVNTIE9SIFJFUFJFU0VOVEFUSVZFIFBST0NFRURJTkcuIElmIGFueSBjb3VydCBvciBhcmJpdHJhdG9yIGRldGVybWluZXMgdGhhdCB0aGUgY2xhc3MgYWN0aW9uIHdhaXZlciBzZXQgZm9ydGggaW4gdGhpcyBwYXJhZ3JhcGggaXMgdm9pZCBvciB1bmVuZm9yY2VhYmxlIGZvciBhbnkgcmVhc29uIG9yIHRoYXQgYW4gYXJiaXRyYXRpb24gY2FuIHByb2NlZWQgb24gYSBjbGFzcyBiYXNpcywgdGhlbiB0aGUgYXJiaXRyYXRpb24gcHJvdmlzaW9uIHNldCBmb3J0aCBhYm92ZSBzaGFsbCBiZSBkZWVtZWQgbnVsbCBhbmQgdm9pZCBpbiBpdHMgZW50aXJldHkgYW5kIHRoZSBwYXJ0aWVzIHNoYWxsIGJlIGRlZW1lZCB0byBoYXZlIG5vdCBhZ3JlZWQgdG8gYXJiaXRyYXRlIGRpc3B1dGVzLgoKIyMjIDEzLjUgRXhjZXB0aW9uIC0gTGl0aWdhdGlvbiBvZiBJbnRlbGxlY3R1YWwgUHJvcGVydHkgYW5kIFNtYWxsIENsYWltcyBDb3VydCBDbGFpbXMgIyMjCgpOb3R3aXRoc3RhbmRpbmcgdGhlIHBhcnRpZXMnIGRlY2lzaW9uIHRvIHJlc29sdmUgYWxsIGRpc3B1dGVzIHRocm91Z2ggYXJiaXRyYXRpb24sIGVpdGhlciBwYXJ0eSBtYXkgYnJpbmcgYW4gYWN0aW9uIGluIHN0YXRlIG9yIGZlZGVyYWwgY291cnQgdG8gcHJvdGVjdCBpdHMgaW50ZWxsZWN0dWFsIHByb3BlcnR5IHJpZ2h0cyAoImludGVsbGVjdHVhbCBwcm9wZXJ0eSByaWdodHMiIG1lYW5zIHBhdGVudHMsIGNvcHlyaWdodHMsIG1vcmFsIHJpZ2h0cywgdHJhZGVtYXJrcywgYW5kIHRyYWRlIHNlY3JldHMsIGJ1dCBub3QgcHJpdmFjeSBvciBwdWJsaWNpdHkgcmlnaHRzKS4gRWl0aGVyIHBhcnR5IG1heSBhbHNvIHNlZWsgcmVsaWVmIGluIGEgc21hbGwgY2xhaW1zIGNvdXJ0IGZvciBkaXNwdXRlcyBvciBjbGFpbXMgd2l0aGluIHRoZSBzY29wZSBvZiB0aGF0IGNvdXJ04oCZcyBqdXJpc2RpY3Rpb24uCgojIyMgMTMuNiAzMC1EYXkgUmlnaHQgdG8gT3B0IE91dCAjIyMKCllvdSBoYXZlIHRoZSByaWdodCB0byBvcHQtb3V0IGFuZCBub3QgYmUgYm91bmQgYnkgdGhlIGFyYml0cmF0aW9uIGFuZCBjbGFzcyBhY3Rpb24gd2FpdmVyIHByb3Zpc2lvbnMgc2V0IGZvcnRoIGFib3ZlIGJ5IHNlbmRpbmcgd3JpdHRlbiBub3RpY2Ugb2YgeW91ciBkZWNpc2lvbiB0byBvcHQtb3V0IHRvIHRoZSBmb2xsb3dpbmcgYWRkcmVzczogTWV0YU1hc2sg4oSFIENvbnNlblN5cywgNDkgQm9nYXJ0IFN0cmVldCwgQnJvb2tseW4gTlkgMTEyMDYgYW5kIHZpYSBlbWFpbCBhdCBsZWdhbC1vcHRAbWV0YW1hc2suaW8uIFRoZSBub3RpY2UgbXVzdCBiZSBzZW50IHdpdGhpbiAzMCBkYXlzIG9mIFNlcHRlbWJlciA2LCAyMDE2IG9yIHlvdXIgZmlyc3QgdXNlIG9mIHRoZSBTZXJ2aWNlLCB3aGljaGV2ZXIgaXMgbGF0ZXIsIG90aGVyd2lzZSB5b3Ugc2hhbGwgYmUgYm91bmQgdG8gYXJiaXRyYXRlIGRpc3B1dGVzIGluIGFjY29yZGFuY2Ugd2l0aCB0aGUgdGVybXMgb2YgdGhvc2UgcGFyYWdyYXBocy4gSWYgeW91IG9wdC1vdXQgb2YgdGhlc2UgYXJiaXRyYXRpb24gcHJvdmlzaW9ucywgTWV0YU1hc2sgYWxzbyB3aWxsIG5vdCBiZSBib3VuZCBieSB0aGVtLgoKIyMjIDEzLjcgQ2hhbmdlcyB0byBUaGlzIFNlY3Rpb24gIyMjCgpNZXRhTWFzayB3aWxsIHByb3ZpZGUgNjAtZGF5c+KAmSBub3RpY2Ugb2YgYW55IGNoYW5nZXMgdG8gdGhpcyBzZWN0aW9uLiBDaGFuZ2VzIHdpbGwgYmVjb21lIGVmZmVjdGl2ZSBvbiB0aGUgNjB0aCBkYXksIGFuZCB3aWxsIGFwcGx5IHByb3NwZWN0aXZlbHkgb25seSB0byBhbnkgY2xhaW1zIGFyaXNpbmcgYWZ0ZXIgdGhlIDYwdGggZGF5LgoKRm9yIGFueSBkaXNwdXRlIG5vdCBzdWJqZWN0IHRvIGFyYml0cmF0aW9uIHlvdSBhbmQgTWV0YU1hc2sgYWdyZWUgdG8gc3VibWl0IHRvIHRoZSBwZXJzb25hbCBhbmQgZXhjbHVzaXZlIGp1cmlzZGljdGlvbiBvZiBhbmQgdmVudWUgaW4gdGhlIGZlZGVyYWwgYW5kIHN0YXRlIGNvdXJ0cyBsb2NhdGVkIGluIE5ldyBZb3JrLCBOZXcgWW9yay4gWW91IGZ1cnRoZXIgYWdyZWUgdG8gYWNjZXB0IHNlcnZpY2Ugb2YgcHJvY2VzcyBieSBtYWlsLCBhbmQgaGVyZWJ5IHdhaXZlIGFueSBhbmQgYWxsIGp1cmlzZGljdGlvbmFsIGFuZCB2ZW51ZSBkZWZlbnNlcyBvdGhlcndpc2UgYXZhaWxhYmxlLgoKVGhlIFRlcm1zIGFuZCB0aGUgcmVsYXRpb25zaGlwIGJldHdlZW4geW91IGFuZCBNZXRhTWFzayBzaGFsbCBiZSBnb3Zlcm5lZCBieSB0aGUgbGF3cyBvZiB0aGUgU3RhdGUgb2YgTmV3IFlvcmsgd2l0aG91dCByZWdhcmQgdG8gY29uZmxpY3Qgb2YgbGF3IHByb3Zpc2lvbnMuCgojIyAxNC4gR2VuZXJhbCBJbmZvcm1hdGlvbiAjIwoKIyMjIDE0LjEgRW50aXJlIEFncmVlbWVudCAjIyMKClRoZXNlIFRlcm1zIChhbmQgYW55IGFkZGl0aW9uYWwgdGVybXMsIHJ1bGVzIGFuZCBjb25kaXRpb25zIG9mIHBhcnRpY2lwYXRpb24gdGhhdCBNZXRhTWFzayBtYXkgcG9zdCBvbiB0aGUgU2VydmljZSkgY29uc3RpdHV0ZSB0aGUgZW50aXJlIGFncmVlbWVudCBiZXR3ZWVuIHlvdSBhbmQgTWV0YU1hc2sgd2l0aCByZXNwZWN0IHRvIHRoZSBTZXJ2aWNlIGFuZCBzdXBlcnNlZGVzIGFueSBwcmlvciBhZ3JlZW1lbnRzLCBvcmFsIG9yIHdyaXR0ZW4sIGJldHdlZW4geW91IGFuZCBNZXRhTWFzay4gSW4gdGhlIGV2ZW50IG9mIGEgY29uZmxpY3QgYmV0d2VlbiB0aGVzZSBUZXJtcyBhbmQgdGhlIGFkZGl0aW9uYWwgdGVybXMsIHJ1bGVzIGFuZCBjb25kaXRpb25zIG9mIHBhcnRpY2lwYXRpb24sIHRoZSBsYXR0ZXIgd2lsbCBwcmV2YWlsIG92ZXIgdGhlIFRlcm1zIHRvIHRoZSBleHRlbnQgb2YgdGhlIGNvbmZsaWN0LgoKIyMjIDE0LjIgV2FpdmVyIGFuZCBTZXZlcmFiaWxpdHkgb2YgVGVybXMgIyMjCgpUaGUgZmFpbHVyZSBvZiBNZXRhTWFzayB0byBleGVyY2lzZSBvciBlbmZvcmNlIGFueSByaWdodCBvciBwcm92aXNpb24gb2YgdGhlIFRlcm1zIHNoYWxsIG5vdCBjb25zdGl0dXRlIGEgd2FpdmVyIG9mIHN1Y2ggcmlnaHQgb3IgcHJvdmlzaW9uLiBJZiBhbnkgcHJvdmlzaW9uIG9mIHRoZSBUZXJtcyBpcyBmb3VuZCBieSBhbiBhcmJpdHJhdG9yIG9yIGNvdXJ0IG9mIGNvbXBldGVudCBqdXJpc2RpY3Rpb24gdG8gYmUgaW52YWxpZCwgdGhlIHBhcnRpZXMgbmV2ZXJ0aGVsZXNzIGFncmVlIHRoYXQgdGhlIGFyYml0cmF0b3Igb3IgY291cnQgc2hvdWxkIGVuZGVhdm9yIHRvIGdpdmUgZWZmZWN0IHRvIHRoZSBwYXJ0aWVzJyBpbnRlbnRpb25zIGFzIHJlZmxlY3RlZCBpbiB0aGUgcHJvdmlzaW9uLCBhbmQgdGhlIG90aGVyIHByb3Zpc2lvbnMgb2YgdGhlIFRlcm1zIHJlbWFpbiBpbiBmdWxsIGZvcmNlIGFuZCBlZmZlY3QuCgojIyMgMTQuMyBTdGF0dXRlIG9mIExpbWl0YXRpb25zICMjIwoKWW91IGFncmVlIHRoYXQgcmVnYXJkbGVzcyBvZiBhbnkgc3RhdHV0ZSBvciBsYXcgdG8gdGhlIGNvbnRyYXJ5LCBhbnkgY2xhaW0gb3IgY2F1c2Ugb2YgYWN0aW9uIGFyaXNpbmcgb3V0IG9mIG9yIHJlbGF0ZWQgdG8gdGhlIHVzZSBvZiB0aGUgU2VydmljZSBvciB0aGUgVGVybXMgbXVzdCBiZSBmaWxlZCB3aXRoaW4gb25lICgxKSB5ZWFyIGFmdGVyIHN1Y2ggY2xhaW0gb3IgY2F1c2Ugb2YgYWN0aW9uIGFyb3NlIG9yIGJlIGZvcmV2ZXIgYmFycmVkLgoKIyMjIDE0LjQgU2VjdGlvbiBUaXRsZXMgIyMjCgpUaGUgc2VjdGlvbiB0aXRsZXMgaW4gdGhlIFRlcm1zIGFyZSBmb3IgY29udmVuaWVuY2Ugb25seSBhbmQgaGF2ZSBubyBsZWdhbCBvciBjb250cmFjdHVhbCBlZmZlY3QuCgojIyMgMTQuNSBDb21tdW5pY2F0aW9ucyAjIyMKClVzZXJzIHdpdGggcXVlc3Rpb25zLCBjb21wbGFpbnRzIG9yIGNsYWltcyB3aXRoIHJlc3BlY3QgdG8gdGhlIFNlcnZpY2UgbWF5IGNvbnRhY3QgdXMgdXNpbmcgdGhlIHJlbGV2YW50IGNvbnRhY3QgaW5mb3JtYXRpb24gc2V0IGZvcnRoIGFib3ZlIGFuZCBhdCBjb21tdW5pY2F0aW9uc0BtZXRhbWFzay5pby4KCiMjIDE1IFJlbGF0ZWQgTGlua3MgIyMKCioqW1Rlcm1zIG9mIFVzZV0oaHR0cHM6Ly9tZXRhbWFzay5pby90ZXJtcy5odG1sKSoqCgoqKltQcml2YWN5XShodHRwczovL21ldGFtYXNrLmlvL3ByaXZhY3kuaHRtbCkqKgoKKipbQXR0cmlidXRpb25zXShodHRwczovL21ldGFtYXNrLmlvL2F0dHJpYnV0aW9ucy5odG1sKSoqCg==", "base64").toString();

const msg = ethUtil.bufferToHex(new Buffer(terms, 'utf8'));

function login(currentAddress, errorCallback, successCallback) {
  web3Process(function (web3) {
    web3.currentProvider.sendAsync(
      {
        'method': 'personal_sign',
        'params': [msg, currentAddress],
        'from': currentAddress
      },
      function (err, result) {
        if (err) {
          return errorCallback(err);
        }

        if (result.error) {
          return errorCallback(result.error);
        }

        const msgParams = {data: msg, sig: result.result};
        const recovered = sigUtil.recoverPersonalSignature(msgParams);

        if (recovered === currentAddress) {
          saveTokenToLocalStorage(currentAddress, result.result);

          return successCallback();
        } else {
          return errorCallback();
        }
      }
    );
  });
}

function logout(currentAddress, successCallback) {
  deleteTokenFromLocalStorage(currentAddress);
  successCallback();
}

function isAuthenticated(address) {
  const token = getTokensFromLocalStorage(address);

  if (token.length > 0) {
    const msgParams = {data: msg, sig: token};
    const recovered = sigUtil.recoverPersonalSignature(msgParams);

    return recovered === address;
  }

  return false;
}

function saveTokenToLocalStorage(address, token) {
  let tokens = getTokensFromLocalStorage();

  tokens[address] = token;
  localStorage.setItem(LOCAL_STORAGE_KEY_TOKENS, JSON.stringify(tokens));
}

function getTokensFromLocalStorage(address) {
  let tokens = localStorage.getItem(LOCAL_STORAGE_KEY_TOKENS);

  if (tokens) {
    tokens = JSON.parse(tokens);

    if (address) {
      return address in tokens ? tokens[address] : {};
    }

    return tokens;
  }

  return {};
}

function deleteTokenFromLocalStorage(address) {
  if (getTokensFromLocalStorage(address)) {
    let tokens = getTokensFromLocalStorage();

    delete tokens[address];

    localStorage.setItem(LOCAL_STORAGE_KEY_TOKENS, JSON.stringify(tokens));
  }
}

export { login, logout, isAuthenticated };